<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galerie Pathétique</title>
    <style>
        @import url('https://fonts.cdnfonts.com/css/helvetica-neue-55');

        :root {
            --bg: #000000;
            --sidebar-bg: #0a0a0a;
            --card-bg: #000000;
            --text: #ffffff;
            --text-dim: #888888;
            --accent: #a90000;
            --border: #333333;
            --hover-bg: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-weight: 400;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            font-size: 11pt;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 1.5rem 0;
        }

        .sidebar-header {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .sidebar-header h1 {
            font-size: 18pt;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: -0.02em;
        }

        .sidebar-header .meta {
            color: var(--text-dim);
            font-size: 10pt;
            margin-top: 0.5rem;
            text-transform: uppercase;
        }

        /* Category accordion */
        .category {
            border-bottom: 1px solid var(--border);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 700;
            font-size: 10pt;
            letter-spacing: 0.05em;
            transition: background 0.15s ease;
        }

        .category-header:hover {
            background: var(--hover-bg);
        }

        .category-header .arrow {
            display: inline-block;
            width: 0;
            height: 0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-left: 6px solid var(--text);
            transition: transform 0.2s ease;
        }

        .category.open .category-header .arrow {
            transform: rotate(90deg);
        }

        .category-items {
            display: none;
            padding-bottom: 0.5rem;
        }

        .category.open .category-items {
            display: block;
        }

        .artist-item {
            padding: 0.5rem 1.5rem 0.5rem 2rem;
            cursor: pointer;
            font-size: 10pt;
            text-transform: uppercase;
            color: var(--text-dim);
            transition: all 0.15s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .artist-item:hover {
            background: var(--hover-bg);
            color: var(--text);
        }

        .artist-item.active {
            color: var(--accent);
            background: var(--hover-bg);
        }

        .artist-item .count {
            font-size: 9pt;
            opacity: 0.6;
        }

        /* UbuWeb nested categories - white bg, black text, red accents */
        .ubu-section {
            border-bottom: 1px solid var(--border);
            background: #ffffff;
        }

        .ubu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 700;
            font-size: 10pt;
            letter-spacing: 0.05em;
            transition: background 0.15s ease;
            background: #ffffff;
            color: var(--accent);
        }

        .ubu-header:hover {
            background: #f5f5f5;
        }

        .ubu-header .arrow {
            display: inline-block;
            width: 0;
            height: 0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-left: 6px solid var(--accent);
            transition: transform 0.2s ease;
        }

        .ubu-section.open .ubu-header .arrow {
            transform: rotate(90deg);
        }

        .ubu-categories {
            display: none;
        }

        .ubu-section.open .ubu-categories {
            display: block;
        }

        .ubu-category {
            border-top: 1px solid var(--border);
        }

        .ubu-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 1.5rem 0.6rem 2rem;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 600;
            font-size: 9pt;
            letter-spacing: 0.03em;
            color: #333333;
            background: #ffffff;
            transition: all 0.15s ease;
        }

        .ubu-category-header:hover {
            background: #f5f5f5;
            color: #000000;
        }

        .ubu-category-header .arrow {
            display: inline-block;
            width: 0;
            height: 0;
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
            border-left: 5px solid var(--accent);
            transition: transform 0.2s ease;
        }

        .ubu-category.open .ubu-category-header .arrow {
            transform: rotate(90deg);
        }

        .ubu-category-items {
            display: none;
            padding-bottom: 0.5rem;
        }

        .ubu-category.open .ubu-category-items {
            display: block;
        }

        .ubu-artist-item {
            padding: 0.4rem 1.5rem 0.4rem 3rem;
            cursor: pointer;
            font-size: 9pt;
            text-transform: uppercase;
            color: #333333;
            background: #ffffff;
            transition: all 0.15s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ubu-artist-item:hover {
            background: #f5f5f5;
            color: #000000;
        }

        .ubu-artist-item.active {
            color: var(--accent);
            background: #f0f0f0;
        }

        .ubu-artist-item .count {
            font-size: 8pt;
            opacity: 0.6;
        }

        /* UbuWeb work items */
        .ubu-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 1rem;
            transition: border-color 0.15s ease;
        }

        .ubu-item:hover {
            border-color: var(--accent);
        }

        .ubu-item-title {
            font-weight: 700;
            font-size: 10pt;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .ubu-item-title a {
            color: var(--text);
            text-decoration: none;
        }

        .ubu-item-title a:hover {
            color: var(--accent);
        }

        .ubu-item-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--accent);
            font-size: 9pt;
            text-decoration: none;
            font-weight: 500;
            text-transform: uppercase;
        }

        .ubu-item-link:hover {
            text-decoration: underline;
        }

        /* Main content */
        .main {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 3rem;
        }

        .main-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .main-header h2 {
            font-size: 28pt;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: -0.02em;
        }

        .main-header .subtitle {
            color: var(--text-dim);
            font-size: 11pt;
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .controls {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        button {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--text);
            padding: 0.4rem 1rem;
            cursor: pointer;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 10pt;
            font-weight: 500;
            text-transform: uppercase;
            transition: all 0.15s ease;
        }

        button:hover {
            background: var(--text);
            color: var(--bg);
        }

        /* Items grid */
        .items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1.5rem;
        }

        .item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 1rem;
            transition: border-color 0.15s ease;
        }

        .item:hover {
            border-color: var(--accent);
        }

        .item-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            margin-bottom: 0.75rem;
            background: #111111;
        }

        .item-title {
            font-weight: 700;
            font-size: 10pt;
            margin-bottom: 0.5rem;
            line-height: 1.3;
            text-transform: uppercase;
        }

        .item-title a {
            color: var(--text);
            text-decoration: none;
        }

        .item-title a:hover {
            color: var(--accent);
        }

        .item-meta {
            font-size: 9pt;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .item-meta-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .meta-value.accent {
            color: var(--accent);
        }

        .item-creator {
            font-size: 9pt;
            color: var(--text-dim);
            font-style: italic;
            margin-top: 0.5rem;
            text-transform: none;
        }

        .open-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--accent);
            font-size: 9pt;
            text-decoration: none;
            font-weight: 500;
            text-transform: uppercase;
        }

        .open-link:hover {
            text-decoration: underline;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-dim);
        }

        .empty-state h3 {
            font-size: 14pt;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        /* Home state */
        .home-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .home-action {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--accent);
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 10pt;
            font-weight: 500;
            text-transform: uppercase;
            transition: all 0.15s ease;
            text-decoration: none;
            display: inline-block;
        }

        .home-action:hover {
            background: var(--accent);
            color: #ffffff;
        }

        /* Clickable title */
        .sidebar-header h1 {
            cursor: pointer;
            transition: color 0.15s ease;
        }

        .sidebar-header h1:hover {
            color: var(--accent);
        }

        .mobile-header h1 {
            cursor: pointer;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Mobile menu toggle */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
        }

        .mobile-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-header h1 {
            font-size: 14pt;
            font-weight: 700;
            text-transform: uppercase;
        }

        .menu-toggle {
            background: none;
            border: 1px solid var(--text);
            color: var(--text);
            padding: 0.5rem 0.75rem;
            font-size: 9pt;
            text-transform: uppercase;
        }

        .menu-toggle.active {
            background: var(--text);
            color: var(--bg);
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .mobile-header {
                display: block;
            }

            .sidebar {
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                z-index: 99;
                transform: translateY(-100%);
                opacity: 0;
                transition: transform 0.3s ease, opacity 0.3s ease;
                overflow-y: auto;
                max-height: calc(100vh - 60px);
            }

            .sidebar.open {
                transform: translateY(0);
                opacity: 1;
            }

            .sidebar-header {
                display: none;
            }

            .main {
                margin-top: 60px;
                padding: 1.5rem;
            }

            .main-header h2 {
                font-size: 18pt;
            }

            .main-header .subtitle {
                font-size: 9pt;
            }

            /* 2-column grid on mobile */
            .items {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .item {
                padding: 0.75rem;
            }

            .item-thumbnail {
                height: 120px;
            }

            .item-title {
                font-size: 9pt;
            }

            .item-meta {
                font-size: 8pt;
            }

            .item-creator {
                font-size: 8pt;
            }

            .open-link {
                font-size: 8pt;
            }

            .category-header {
                padding: 1rem 1.5rem;
            }

            .artist-item {
                padding: 0.75rem 1.5rem 0.75rem 2rem;
            }
        }

        /* Small mobile - single column */
        @media (max-width: 400px) {
            .items {
                grid-template-columns: 1fr;
            }
        }

        /* Password overlay */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-overlay.hidden {
            display: none;
        }

        .password-box {
            text-align: center;
            padding: 3rem;
            max-width: 400px;
        }

        .password-box h2 {
            font-size: 24pt;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 2rem;
            letter-spacing: -0.02em;
        }

        .password-box input {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem 1rem;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 11pt;
            width: 100%;
            margin-bottom: 1rem;
            text-align: center;
        }

        .password-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .password-box button {
            width: 100%;
            padding: 0.75rem 1.5rem;
        }

        .password-box .error {
            color: var(--accent);
            font-size: 10pt;
            margin-top: 1rem;
            text-transform: uppercase;
            display: none;
        }

        .password-box .error.visible {
            display: block;
        }
    </style>
</head>
<body>

    <!-- Password overlay -->
    <div class="password-overlay" id="password-overlay">
        <div class="password-box">
            <h2>Galerie Pathétique</h2>
            <input type="password" id="password-input" placeholder="Enter password" autocomplete="off">
            <button onclick="checkPassword()">Enter</button>
            <p class="error" id="password-error">Incorrect password</p>
        </div>
    </div>

    <!-- Mobile header -->
    <div class="mobile-header">
        <div class="mobile-header-content">
            <h1 onclick="goHome()">Galerie Pathétique</h1>
            <button class="menu-toggle" onclick="toggleMobileMenu()">Menu</button>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 onclick="goHome()">Galerie Pathétique</h1>
            <p class="meta" id="stats">Loading...</p>
        </div>
        <nav id="nav"></nav>
    </aside>

    <main class="main">
        <div class="loading" id="loading">Loading data...</div>
        <div id="content" style="display: none;">
            <header class="main-header">
                <h2 id="current-title">Select something</h2>
                <p class="subtitle" id="current-subtitle"></p>
            </header>
            <div class="items" id="items"></div>
        </div>
    </main>

    <script>
        const CSV_FILE = 'data.csv';
        const UBU_DATA_DIR = 'ubu_data';
        let allData = [];
        let ubuData = {};
        let currentItems = [];
        let isUbuView = false;

        // Media type pools for random selection
        let mediaPool = {
            all: [],
            video: [],
            text: [],
            audio: []
        };

        // UbuWeb category to media type mapping
        const UBU_MEDIA_MAP = {
            'Film & Video': 'video',
            'Sound': 'audio',
            'Dance': 'video',
            'Papers': 'text',
            'Historical': 'text',
            'Visual Poetry': 'text',
            'Conceptual Comics': 'text',
            'Conceptual Writing': 'text',
            'Contemporary': 'text',
            'Aspen Magazine': 'text',
            'Outsiders': 'audio',
            '/ubu Editions': 'text',
            '365 Days Project': 'audio',
            'Ethnopoetics': 'text',
            'Electronic Music Resources': 'audio',
            'UbuWeb Top Tens': 'video'
        };

        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.menu-toggle');
            sidebar.classList.toggle('open');
            toggle.classList.toggle('active');
            toggle.textContent = sidebar.classList.contains('open') ? 'Close' : 'Menu';
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.menu-toggle');
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
                toggle.classList.remove('active');
                toggle.textContent = 'Menu';
            }
        }

        // Home and random functions
        function goHome() {
            document.querySelectorAll('.artist-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.ubu-artist-item').forEach(el => el.classList.remove('active'));
            document.getElementById('current-title').textContent = 'Select something';
            document.getElementById('current-subtitle').textContent = '';
            document.getElementById('items').innerHTML = '';
            currentItems = [];
            isUbuView = false;
            closeMobileMenu();
        }

        function buildMediaPools() {
            mediaPool = { all: [], video: [], text: [], audio: [] };

            // Add archive.org items
            allData.forEach(item => {
                const poolItem = {
                    type: 'archive',
                    title: item.title,
                    url: item.url,
                    category: item.category,
                    artist: item.search_term,
                    mediatype: item.mediatype,
                    data: item
                };
                mediaPool.all.push(poolItem);

                if (item.mediatype === 'movies') mediaPool.video.push(poolItem);
                else if (item.mediatype === 'texts') mediaPool.text.push(poolItem);
                else if (item.mediatype === 'audio') mediaPool.audio.push(poolItem);
            });

            // Add UbuWeb items
            Object.keys(ubuData).forEach(category => {
                const mediaType = UBU_MEDIA_MAP[category] || 'text';
                ubuData[category].forEach(row => {
                    // Parse works if available
                    if (row.works) {
                        const titles = row.works.split(', ').filter(t => t.trim());
                        const urls = row.work_urls ? row.work_urls.split(', ').filter(u => u.trim()) : [];
                        titles.forEach((title, i) => {
                            const poolItem = {
                                type: 'ubu',
                                title: title.trim(),
                                url: urls[i] ? urls[i].trim() : row.artist_url,
                                category: category,
                                artist: row.artist_name,
                                mediatype: mediaType,
                                data: row
                            };
                            mediaPool.all.push(poolItem);
                            if (mediaType === 'video') mediaPool.video.push(poolItem);
                            else if (mediaType === 'text') mediaPool.text.push(poolItem);
                            else if (mediaType === 'audio') mediaPool.audio.push(poolItem);
                        });
                    } else {
                        // For items like Aspen with content_html
                        const poolItem = {
                            type: 'ubu',
                            title: row.artist_name,
                            url: row.artist_url,
                            category: category,
                            artist: row.artist_name,
                            mediatype: mediaType,
                            data: row
                        };
                        mediaPool.all.push(poolItem);
                        if (mediaType === 'video') mediaPool.video.push(poolItem);
                        else if (mediaType === 'text') mediaPool.text.push(poolItem);
                        else if (mediaType === 'audio') mediaPool.audio.push(poolItem);
                    }
                });
            });
        }

        function showRandom() {
            if (mediaPool.all.length === 0) return;
            const item = mediaPool.all[Math.floor(Math.random() * mediaPool.all.length)];
            displayRandomItem(item);
        }

        function showRandomVideo() {
            if (mediaPool.video.length === 0) {
                alert('No video items available');
                return;
            }
            const item = mediaPool.video[Math.floor(Math.random() * mediaPool.video.length)];
            displayRandomItem(item);
        }

        function showRandomText() {
            if (mediaPool.text.length === 0) {
                alert('No text items available');
                return;
            }
            const item = mediaPool.text[Math.floor(Math.random() * mediaPool.text.length)];
            displayRandomItem(item);
        }

        function displayRandomItem(item) {
            document.getElementById('current-title').textContent = item.title;
            document.getElementById('current-subtitle').textContent = `${item.type === 'ubu' ? 'UbuWeb' : 'Archive.org'} / ${item.category} / ${item.artist}`;

            const container = document.getElementById('items');

            if (item.type === 'archive') {
                container.innerHTML = `
                    <div class="item" style="grid-column: 1 / -1; max-width: 400px;">
                        <a href="${item.url}" target="_blank">
                            <img class="item-thumbnail"
                                 src="https://archive.org/services/img/${item.data.identifier}"
                                 alt="${item.title}"
                                 loading="lazy"
                                 onerror="this.style.display='none'">
                        </a>
                        <div class="item-title">
                            <a href="${item.url}" target="_blank">${item.title}</a>
                        </div>
                        <div class="item-meta">
                            <div class="item-meta-row">
                                <span>Type</span>
                                <span class="meta-value">${item.data.mediatype}</span>
                            </div>
                        </div>
                        ${item.data.creator ? `<div class="item-creator">${item.data.creator}</div>` : ''}
                        <a href="${item.url}" target="_blank" class="open-link">View →</a>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="ubu-item" style="grid-column: 1 / -1; max-width: 400px;">
                        <div class="ubu-item-title">
                            <a href="${item.url}" target="_blank">${item.title}</a>
                        </div>
                        <div class="item-meta">
                            <div class="item-meta-row">
                                <span>Artist</span>
                                <span class="meta-value">${item.artist}</span>
                            </div>
                        </div>
                        <a href="${item.url}" target="_blank" class="ubu-item-link">Open →</a>
                    </div>
                `;
            }
        }

        // Parse CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => row[h] = values[idx] || '');
                data.push(row);
            }
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Build navigation
        function buildNav(data) {
            const nav = document.getElementById('nav');
            const structure = {};

            // Group by category -> artist
            data.forEach(item => {
                const cat = item.category || 'Uncategorized';
                const artist = item.search_term || 'Unknown';

                if (!structure[cat]) structure[cat] = {};
                if (!structure[cat][artist]) structure[cat][artist] = [];
                structure[cat][artist].push(item);
            });

            nav.innerHTML = '';

            Object.keys(structure).sort().forEach(category => {
                const artists = structure[category];
                const artistCount = Object.keys(artists).length;
                const itemCount = Object.values(artists).flat().length;

                const catDiv = document.createElement('div');
                catDiv.className = 'category';
                catDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory(this)">
                        <span>${category} (${itemCount})</span>
                        <span class="arrow"></span>
                    </div>
                    <div class="category-items"></div>
                `;

                const itemsDiv = catDiv.querySelector('.category-items');
                Object.keys(artists).sort().forEach(artist => {
                    const items = artists[artist];
                    const artistDiv = document.createElement('div');
                    artistDiv.className = 'artist-item';
                    artistDiv.innerHTML = `
                        <span>${artist}</span>
                        <span class="count">${items.length}</span>
                    `;
                    artistDiv.onclick = () => showArtist(category, artist, items);
                    itemsDiv.appendChild(artistDiv);
                });

                nav.appendChild(catDiv);
            });

            // Update stats
            const categories = Object.keys(structure).length;
            const artists = Object.values(structure).reduce((acc, cat) => acc + Object.keys(cat).length, 0);
            document.getElementById('stats').textContent = `${data.length} items / ${artists} artists / ${categories} categories`;
        }

        function toggleCategory(header) {
            const isOpen = header.parentElement.classList.contains('open');
            // Close all categories and ubu sections
            document.querySelectorAll('.category.open, .ubu-section.open, .ubu-category.open').forEach(el => el.classList.remove('open'));
            // Open this one if it wasn't already open
            if (!isOpen) header.parentElement.classList.add('open');
        }

        function showArtist(category, artist, items) {
            // Update active state
            document.querySelectorAll('.artist-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.ubu-artist-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Update header
            document.getElementById('current-title').textContent = artist;
            document.getElementById('current-subtitle').textContent = `${category} / ${items.length} items`;

            // Store current items for actions
            currentItems = items;
            isUbuView = false;

            // Render items
            renderItems(items);

            // Close mobile menu after selection
            closeMobileMenu();
        }

        function renderItems(items) {
            const container = document.getElementById('items');
            container.innerHTML = items.map(item => `
                <div class="item" data-url="${item.url}">
                    <a href="${item.url}" target="_blank">
                        <img class="item-thumbnail"
                             src="https://archive.org/services/img/${item.identifier}"
                             alt="${item.title}"
                             loading="lazy"
                             onerror="this.style.display='none'">
                    </a>
                    <div class="item-title">
                        <a href="${item.url}" target="_blank">${item.title}</a>
                    </div>
                    <div class="item-meta">
                        <div class="item-meta-row">
                            <span>Confidence</span>
                            <span class="meta-value accent">${item.confidence_score}</span>
                        </div>
                        <div class="item-meta-row">
                            <span>Type</span>
                            <span class="meta-value">${item.mediatype}</span>
                        </div>
                    </div>
                    ${item.creator ? `<div class="item-creator">${item.creator}</div>` : ''}
                    <a href="${item.url}" target="_blank" class="open-link">View →</a>
                </div>
            `).join('');
        }

        function openAllVisible() {
            if (currentItems.length === 0) return;
            if (confirm(`Open ${currentItems.length} tabs?`)) {
                currentItems.forEach(item => window.open(item.url, '_blank'));
            }
        }

        function copyVisibleUrls() {
            if (currentItems.length === 0) return;
            const urls = currentItems.map(item => item.url).join('\n');
            navigator.clipboard.writeText(urls).then(() => alert('URLs copied!'));
        }

        // UbuWeb functions
        async function loadUbuData() {
            try {
                const knownCategories = [
                    'film_and_video', 'sound', 'dance', 'papers', 'historical',
                    'visual_poetry', 'conceptual_comics', 'conceptual_writing',
                    'contemporary', 'aspen_magazine', 'outsiders', '_ubu_editions',
                    '365_days_project', 'ethnopoetics', 'electronic_music_resources',
                    'ubuweb_top_tens'
                ];

                const loadPromises = knownCategories.map(async (cat) => {
                    try {
                        const res = await fetch(`${UBU_DATA_DIR}/${cat}.csv`);
                        if (!res.ok) return null;
                        const text = await res.text();
                        const data = parseCSV(text);
                        if (data.length > 0) {
                            return { category: data[0].category || cat, artists: data };
                        }
                    } catch (e) {
                        return null;
                    }
                    return null;
                });

                const results = await Promise.all(loadPromises);
                results.filter(r => r !== null).forEach(r => {
                    ubuData[r.category] = r.artists;
                });

                if (Object.keys(ubuData).length > 0) {
                    buildUbuNav();
                }
            } catch (err) {
                console.log('UbuWeb data not available:', err.message);
            }
        }

        function buildUbuNav() {
            const nav = document.getElementById('nav');

            const ubuSection = document.createElement('div');
            ubuSection.className = 'ubu-section';
            ubuSection.innerHTML = `
                <div class="ubu-header" onclick="toggleUbuSection(this)">
                    <span>Browse UbuWeb</span>
                    <span class="arrow"></span>
                </div>
                <div class="ubu-categories"></div>
            `;

            const categoriesDiv = ubuSection.querySelector('.ubu-categories');

            Object.keys(ubuData).sort().forEach(category => {
                const artists = ubuData[category];

                const artistMap = {};
                artists.forEach(row => {
                    const name = row.artist_name;
                    if (!artistMap[name]) {
                        artistMap[name] = {
                            name: name,
                            url: row.artist_url,
                            works: [],
                            work_urls: [],
                            content_html: row.content_html || ''
                        };
                    }
                    if (row.works) {
                        const titles = row.works.split(', ').filter(t => t.trim());
                        const urls = row.work_urls ? row.work_urls.split(', ').filter(u => u.trim()) : [];
                        titles.forEach((title, i) => {
                            artistMap[name].works.push({
                                title: title.trim(),
                                url: urls[i] ? urls[i].trim() : '#'
                            });
                        });
                    }
                });

                const artistList = Object.values(artistMap);

                const catDiv = document.createElement('div');
                catDiv.className = 'ubu-category';
                catDiv.innerHTML = `
                    <div class="ubu-category-header" onclick="toggleUbuCategory(this)">
                        <span>${category} (${artistList.length})</span>
                        <span class="arrow"></span>
                    </div>
                    <div class="ubu-category-items"></div>
                `;

                const itemsDiv = catDiv.querySelector('.ubu-category-items');
                artistList.sort((a, b) => a.name.localeCompare(b.name)).forEach(artist => {
                    const artistDiv = document.createElement('div');
                    artistDiv.className = 'ubu-artist-item';
                    artistDiv.innerHTML = `
                        <span>${artist.name}</span>
                        <span class="count">${artist.works.length}</span>
                    `;
                    artistDiv.onclick = (e) => {
                        e.stopPropagation();
                        showUbuArtist(category, artist);
                    };
                    itemsDiv.appendChild(artistDiv);
                });

                categoriesDiv.appendChild(catDiv);
            });

            nav.appendChild(ubuSection);

            // Add "Show Me Something" section with random buttons
            const randomSection = document.createElement('div');
            randomSection.className = 'category';
            randomSection.innerHTML = `
                <div class="category-header" onclick="toggleCategory(this)">
                    <span>Show Me Something</span>
                    <span class="arrow"></span>
                </div>
                <div class="category-items">
                    <div class="artist-item" onclick="showRandom(); event.stopPropagation();">
                        <span>Random Item</span>
                    </div>
                    <div class="artist-item" onclick="showRandomVideo(); event.stopPropagation();">
                        <span>Random Video</span>
                    </div>
                    <div class="artist-item" onclick="showRandomText(); event.stopPropagation();">
                        <span>Random Text</span>
                    </div>
                </div>
            `;
            nav.appendChild(randomSection);

            updateStats();
        }

        function toggleUbuSection(header) {
            const isOpen = header.parentElement.classList.contains('open');
            // Close all categories and ubu sections
            document.querySelectorAll('.category.open, .ubu-section.open, .ubu-category.open').forEach(el => el.classList.remove('open'));
            // Open this one if it wasn't already open
            if (!isOpen) header.parentElement.classList.add('open');
        }

        function toggleUbuCategory(header) {
            const isOpen = header.parentElement.classList.contains('open');
            // Close other ubu categories (but keep parent ubu-section open)
            document.querySelectorAll('.ubu-category.open').forEach(el => el.classList.remove('open'));
            // Open this one if it wasn't already open
            if (!isOpen) header.parentElement.classList.add('open');
        }

        function showUbuArtist(category, artist) {
            document.querySelectorAll('.artist-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.ubu-artist-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            document.getElementById('current-title').textContent = artist.name;

            isUbuView = true;

            // Check if this is HTML content (like Aspen Magazine)
            if (artist.content_html) {
                document.getElementById('current-subtitle').textContent = `UbuWeb / ${category}`;
                currentItems = [];
                renderUbuHtmlContent(artist.content_html, artist.url);
            } else {
                document.getElementById('current-subtitle').textContent = `UbuWeb / ${category} / ${artist.works.length} works`;
                currentItems = artist.works;
                renderUbuItems(artist.works, artist.url);
            }

            closeMobileMenu();
        }

        function renderUbuItems(works, artistUrl) {
            const container = document.getElementById('items');

            let html = '';
            if (artistUrl && artistUrl !== '#') {
                html += `
                    <div class="ubu-item" style="grid-column: 1 / -1; background: var(--hover-bg);">
                        <div class="ubu-item-title">
                            <a href="${artistUrl}" target="_blank">→ View Artist Page on UbuWeb</a>
                        </div>
                    </div>
                `;
            }

            html += works.map(work => `
                <div class="ubu-item">
                    <div class="ubu-item-title">
                        <a href="${work.url}" target="_blank">${work.title}</a>
                    </div>
                    <a href="${work.url}" target="_blank" class="ubu-item-link">Open →</a>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function renderUbuHtmlContent(contentHtml, artistUrl) {
            const container = document.getElementById('items');

            // Parse the HTML to extract text and links
            const parser = new DOMParser();
            // Convert &#10; back to newlines for parsing
            const cleanHtml = contentHtml.replace(/&#10;/g, '\n');
            const doc = parser.parseFromString(cleanHtml, 'text/html');

            let html = '';

            // Add link to original page
            if (artistUrl && artistUrl !== '#') {
                html += `
                    <div class="ubu-item" style="grid-column: 1 / -1; background: var(--hover-bg); margin-bottom: 1rem;">
                        <div class="ubu-item-title">
                            <a href="${artistUrl}" target="_blank">→ View Original Page on UbuWeb</a>
                        </div>
                    </div>
                `;
            }

            // Extract all links from the content
            const links = doc.querySelectorAll('a[href]');
            const seenUrls = new Set();

            links.forEach(link => {
                let href = link.getAttribute('href');
                const text = link.textContent.trim();

                if (!text || !href || href === '#') return;

                // Make relative URLs absolute
                if (!href.startsWith('http')) {
                    const base = artistUrl.substring(0, artistUrl.lastIndexOf('/') + 1);
                    href = base + href;
                }

                // Skip duplicates and navigation links
                if (seenUrls.has(href) || href.includes('index.html') && !href.includes('/aspen')) return;
                seenUrls.add(href);

                html += `
                    <div class="ubu-item">
                        <div class="ubu-item-title">
                            <a href="${href}" target="_blank">${text}</a>
                        </div>
                        <a href="${href}" target="_blank" class="ubu-item-link">Open →</a>
                    </div>
                `;
            });

            // If no links found, show the text content
            if (links.length === 0) {
                const textContent = doc.body.textContent.trim();
                html += `
                    <div class="ubu-item" style="grid-column: 1 / -1;">
                        <div style="white-space: pre-wrap; font-size: 10pt; line-height: 1.6;">${textContent}</div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function updateStats() {
            const archiveItems = allData.length;
            const archiveArtists = new Set(allData.map(d => d.search_term)).size;
            const archiveCategories = new Set(allData.map(d => d.category)).size;

            let ubuWorks = 0;
            Object.values(ubuData).forEach(artists => {
                artists.forEach(a => {
                    if (a.works) {
                        ubuWorks += a.works.split(', ').filter(w => w.trim()).length;
                    }
                });
            });

            const ubuCategories = Object.keys(ubuData).length;

            let statsText = `${archiveItems} items / ${archiveArtists} artists / ${archiveCategories} categories`;
            if (ubuCategories > 0) {
                statsText += ` + UbuWeb: ${ubuWorks} works`;
            }
            document.getElementById('stats').textContent = statsText;
        }

        // Load data
        async function init() {
            try {
                const res = await fetch(CSV_FILE);
                if (res.ok) {
                    const text = await res.text();
                    allData = parseCSV(text);
                    buildNav(allData);
                }

                await loadUbuData();
                updateStats();
                buildMediaPools();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (err) {
                document.getElementById('loading').innerHTML = `
                    <p>Error loading data: ${err.message}</p>
                    <p style="margin-top: 1rem;">Make sure <code>${CSV_FILE}</code> or <code>${UBU_DATA_DIR}/</code> exists.</p>
                `;
            }
        }

        init();

        // Password protection - Pure JS SHA-256 (works without HTTPS)
        const PASSWORD_HASH = 'a426d341d4df5b76e34f7b322b4d524ae8ebacef7b79830f1dbf818fbb59daad';
        const AUTH_KEY = 'galerie_auth_' + PASSWORD_HASH.substring(0, 8);

        function sha256(str) {
            const K = [
                0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
                0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
                0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
                0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
                0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
                0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
                0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
                0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
            ];
            const H = [0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19];
            const rotr = (n, x) => (x >>> n) | (x << (32 - n));
            const bytes = new TextEncoder().encode(str);
            const bits = bytes.length * 8;
            const padding = new Uint8Array(((bytes.length + 9 + 63) & ~63));
            padding.set(bytes);
            padding[bytes.length] = 0x80;
            new DataView(padding.buffer).setUint32(padding.length - 4, bits, false);
            for (let i = 0; i < padding.length; i += 64) {
                const W = new Uint32Array(64);
                for (let t = 0; t < 16; t++) W[t] = new DataView(padding.buffer).getUint32(i + t * 4, false);
                for (let t = 16; t < 64; t++) {
                    const s0 = rotr(7, W[t-15]) ^ rotr(18, W[t-15]) ^ (W[t-15] >>> 3);
                    const s1 = rotr(17, W[t-2]) ^ rotr(19, W[t-2]) ^ (W[t-2] >>> 10);
                    W[t] = (W[t-16] + s0 + W[t-7] + s1) >>> 0;
                }
                let [a, b, c, d, e, f, g, h] = H;
                for (let t = 0; t < 64; t++) {
                    const S1 = rotr(6, e) ^ rotr(11, e) ^ rotr(25, e);
                    const ch = (e & f) ^ (~e & g);
                    const t1 = (h + S1 + ch + K[t] + W[t]) >>> 0;
                    const S0 = rotr(2, a) ^ rotr(13, a) ^ rotr(22, a);
                    const maj = (a & b) ^ (a & c) ^ (b & c);
                    const t2 = (S0 + maj) >>> 0;
                    h = g; g = f; f = e; e = (d + t1) >>> 0; d = c; c = b; b = a; a = (t1 + t2) >>> 0;
                }
                H[0] = (H[0] + a) >>> 0; H[1] = (H[1] + b) >>> 0; H[2] = (H[2] + c) >>> 0; H[3] = (H[3] + d) >>> 0;
                H[4] = (H[4] + e) >>> 0; H[5] = (H[5] + f) >>> 0; H[6] = (H[6] + g) >>> 0; H[7] = (H[7] + h) >>> 0;
            }
            return H.map(v => v.toString(16).padStart(8, '0')).join('');
        }

        function checkPassword() {
            const input = document.getElementById('password-input');
            const error = document.getElementById('password-error');
            const hash = sha256(input.value);

            if (hash === PASSWORD_HASH) {
                sessionStorage.setItem(AUTH_KEY, 'authenticated');
                document.getElementById('password-overlay').classList.add('hidden');
            } else {
                error.classList.add('visible');
                input.value = '';
                input.focus();
            }
        }

        // Handle enter key
        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });

        // Check if already authenticated
        if (sessionStorage.getItem(AUTH_KEY) === 'authenticated') {
            document.getElementById('password-overlay').classList.add('hidden');
        } else {
            document.getElementById('password-input').focus();
        }

    </script>
</body>
</html>
